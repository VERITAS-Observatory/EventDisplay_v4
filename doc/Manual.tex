%*-- Author :    G.Maier   2011/09/25
\documentclass[titlepage,a4paper,twoside,11pt]{report}
% floating objects
\usepackage{float}
% floating object placements
\usepackage{afterpage}
% use more of a page
\usepackage{a4wide}
% sort citation numbers
\usepackage{cite}
% more symbols, e.g. \blacksquare, \blacktriangle
\usepackage{amssymb}
% \usepackage{lscape}  % landscape with \begin{landscape} \end{landscape}
% header with lines etc.
\usepackage{fancyheadings}
\usepackage{longtable} % table longer than one page
\usepackage{booktabs} % toprule, etc.

% captions in italic
\usepackage{caption2}
\renewcommand*\captionfont{\slshape}
\renewcommand*\captionlabelfont{\upshape}
% versions
\usepackage{version}
 \includeversion{TEV}
 \excludeversion{GREEN}
 \excludeversion{LMX}
 \excludeversion{HMX}
 \excludeversion{EGRET}
\excludeversion{TAYLOR}

\usepackage[pdftex]{graphicx}
\pdfcompresslevel=0   % pdf-file should (not) be compressed
\usepackage[pdftex]{color}
% make bookmarks, don't show bookmarks when opening the file
\usepackage[pdftex,colorlinks=false,bookmarks=false,bookmarksopen=false]{hyperref}
\pdfinfo
  {
      /Title (promo.pdf)
      /Creator (TeX)
      /Producer (pdfTeX)
      /Author (Gernot Maier)
      /CreationDate (D:20110925180100)
      /ModDate (D:20110925180100)
      /Subject (manual)
      /Keywords (gamma rays, analysis, VERITAS, CTA)
  }
%  \usepackage{thumbpdf}

%%%%%%%%%%%%%%%
%% pdflatex configure file ????
%% To include a graphics file \includegraphics{filename_to_include}
%% convert eps files with epstopdf

% no header and no page number, ersetzt \cleardoublepage
\newcommand{\clearemptydoublepage}{\newpage{\pagestyle{empty}\cleardoublepage}}

% new headers
\pagestyle{fancyplain}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\lhead[\fancyplain{}{\bfseries\thepage}]{\fancyplain{}{\bfseries\rightmark}}
\rhead[\fancyplain{}{\bfseries\leftmark}]{\fancyplain{}{\bfseries\thepage}}
\cfoot{\fancyplain{\thepage}}

% \marginlabel, replaces \marginpar 
\newcommand{\marginlabel}[1]{\mbox{}\marginpar{\raggedleft\hspace{0pt}{\color{cyan}#1}}}
% degrees
\newcommand{\Grad}{$^{\circ}$}
%% new color
\definecolor{Grau}{gray}{0.905}
\usepackage{listings}
\lstset{language=C++, basicstyle=\small,backgroundcolor=\color{Grau},aboveskip=\bigskipamount,belowskip=\bigskipamount,frame=TB}
\renewcommand{\textfraction}{0.02}
\renewcommand{\floatpagefraction}{0.70}

% spelling
\hyphenation{CRES KRETA KASCADE GHEISHA Karls-ruhe CORSIKA}

%indent
\setlength{\parindent}{0pt}

\begin{document}

% ########### title page ###########################

\include{Manual_Title}

% ############ Vorspann  ###########################

\pagenumbering{roman}
\thispagestyle{empty}

\begin{abstract}

\noindent eventdisplay is a complete package for VERITAS and CTA analysis (whatever 'complete' means...)
The package consists of several analysis steps and tools:

\begin{enumerate}
\item evndisp (calibrate and parametrize images, event reconstruction, stereo analysis)
\item mscw\_energy (use lookup tables to produce msw, msl, and energies)
\item anasum (produce maps and calculate analysis results)
\item shared library tools and macros  (produce the energy spectrum and integral fluxes, plot maps, plot sensitivities, etc.) 
\item makeEffectiveArea (calculate effective areas)
\item trainTMVAforGammaHadronSeparation (tools to train MVA and optimize cuts)
\item ...
\end{enumerate}

This is a very incomplete manual, started in September 2009. Please help updating it.

\end{abstract}


\setcounter{page}{1}
\tableofcontents
\clearemptydoublepage


% ############ main part #####################
\pagenumbering{arabic}

\chapter{Documentation}

EVNDISP is work-in-progress and the documentation is not in the state it is supposed to be. 
Apart from the information in this manual, other sources for help are:

\subsection*{README files}

\begin{description}
\item[INSTALL:]   information on installation the analysis package, dependencies, environmental variables
\item[README.CTA :]  short description of a typical CTA analysis
\item[README.VTS:]      description of a typical VERITAS analysis
\item[AUTHORS:]		author description
\end{description}

\noindent Description and command line options for the different software parts:

\begin{description}
\item[README.EVNDISP:]
\item[README.MSCW\_ENERGY:]
\item[README.ANASUM:]
\item[README.EFFECTIVEAREA:]
\item[README.ANALYSISLIBRARY:]
\item[README.SCRIPTS:]
\item[README.MACROS:]
\end{description}

\subsection*{WIKI pages}

The EVNDISP manual for VERITAS users: 

\url{http://veritas.sao.arizona.edu/wiki/index.php/Eventdisplay\_Manual}

\clearemptydoublepage

\chapter{Introduction}

% #############################################
%
% ############ Installation and auxiliary data files ######
%
% #############################################

\chapter{Installation and auxiliary data files}

\section{Auxiliary data files}
\label{SECTION.AUXFILE}

The auxiliary data files contain information needed for the analysis. 
This might be files describing the detector geometry, lookup tables, effective areas file, etc.
We assume in the following that these files are located in the directory {\it \$EVNDISPDATA}

\subsection{Detector description}

\subsubsection{VERITAS}

\subsubsection{CTA}

No detector description is needed, since the telescope and array description is read directly from the DST file ({\it telconfig} tree).
The converter from hessio to EVNDISP DST format needs a subarray file, a simple list of telescopes to be selected from the corresponding hyper array. 
The subarray files for prod1 can be found in {\it \$EVNDISPDATA/DetectorGeometry/*.lis}.

\chapter{eventdisplay - calibration, image analysis and stereo reconstruction}

% #############################################
%
% ############ CTA analysis ######################
%
% #############################################

\chapter{CTA analysis}

\section{General concept}

To use Eventdisplay for CTA analyses, you first have to convert the {\it simtel.gz} file into ROOT format. 
This you have to do for each subarray separately.
Afterwards you can analyze this subarray file running {\it eventdisplay} in the standard way, which means:

\begin{description}
\item[CTA.convert\_hessio\_to\_VDST]
        convert simtel.gz files into ROOT format

\item[eventdisplay]
	image cleaning \& calculation of telescope parameters \& reconstruction of the direction and core; display

\item[mscw\_energy]
        train and use lookup tables to estimate the energy and mean scaled parameters
        
\item[trainTMVAforGammaHadronSeparation]
        optimize cuts or train MVA

\item[makeEffectiveArea]
        make effective areas

\item[\$EVNDISPSYS/macros/plot\_sensitivity.C]
        plot sensitivity curves
\end{description}

(For most of these steps there are scripts to run the analysis on the DESY batch system. Use them to simplify your life.)

\section{Analysis}

%###########################################################################
\subsection{Step 1: Converter}

In this step a simulation data file in hessio format is converted to the EVNDISP DST format 
(see \ref{SECTION.DST}). These are the possible options to run the converter:

\begin{lstlisting}
$EVNDISPSYS/bin/CTA.convert_hessio_to_VDST

c_DST: A program to convert hessio data to EVNDISP DST files (v.4.00)
=====================================================================

Syntax: ./bin/CTA.convert_hessio_to_VDST [ options ] [ - | input_fname ... ]
Options:
   -v               (More verbose output)
   -q               (Much more quiet output)
   -s               (Show data explained)
   -S               (Show data explained, including raw data)
   --history (-h)   (Show contents of history data block)
   -i               (Ignore unknown data block types)
   --max-events n   (Skip remaining data after so many triggered events.)
   -a subarray file (list of telescopes to read with FOV.)
   -o dst filename  (name of dst output file)
   -f on=1/off=0    (write FADC samples to DST file;default=0)
\end{lstlisting}

The following options are necessary: -a and -o.
Note the limitations of the DST format (\ref{SUBSECTION.DST.LIMITATIONS}).

Note that many of the CTA simulation files contain data for a so called hyper array. 
To select the actual array, the corresponding subarray has to be specified in a ASCII text file (called {\it subarray} file in the following).
The following example file selects an array consisting of telescopes 63, 19, 67, and 33, each telescope
with a field of view of 8 degrees:

\begin{lstlisting}
63 8
19 8
67 8
33 8
\end{lstlisting}

Subarray files for most of the typical arrays used in the CTA sensitivities studies are part of the analysis file package 
(see \ref{SECTION.AUXFILE}). Note that a subarray file is always needed, even if all telescopes from the hessio file are read out.

For a typical run, the following command line should be used:

\begin{lstlisting}
./CTA.convert_hessio_to_VDST -a subArray.list -o dstfile.dst.root \ 
          gamma_run12241.simhess.gz  
\end{lstlisting}

For FADC analysis, add the option {\it -f 1}. Note again the limitations of the DST format (\ref{SUBSECTION.DST.LIMITATIONS}).


\subsection{Step 2: Display (event-by-event)}

It is always useful to look at events in the display. 
To do this, it is best to select a small subarray with the {\it -teltoana} option in evndisp.
The display might otherwise be quite slow in responding to your input due to the large number of objects to be drawn.

A typical command line to look at events might be (remove the {\it -traceanalysis=1} command for dst files without trace information):

\begin{lstlisting}
$EVNDISPSYS/bin/evndisp -display=1 \
-reconstructionparameter ./EVNDISP.reconstruction.runparameter \
-useFixedThresholds  -imagethresh=10.0 -borderthresh=5.0 \
-l2setspecialchannels nofile \
-sourcefile tt.v2.root  -traceanalysis=1
\end{lstlisting}

\subsection{Step 3: Calibration, image analysis and stereo reconstruction}

\subsection{Step 1 \& 3 combined [USE]}

Run the converter and Eventdisplay for a specific subarray: use script \$EVNDISPSYS/scripts/CTA/CTA.EVNDISP.sub\_convert\_and\_analyse\_MC\_VDST.sh

NOTE: The image cleaning thresholds can be specified in the file \$EVNDISPDATA/ParameterFiles/EVNDISP.reconstruction.runparameter file either
for all telescopes to the same values or for each telescope type seperately. 

\subsection{Step 4: mscw\_energy}

If you use standard configurations maybe some lookup tables already exist (ask Gernot or Heike where you could find them).

If not, you have to create them yourself with

\$EVNDISPSYS/scripts/CTA/CTA.MSCW\_ENERGY.sub\_make\_tables.sh

If you have your lookup tables you have to run mscw\_energy for estimating the energy of each event: 

\$EVNDISPSYS/scripts/CTA/CTA.MSCW\_ENERGY.sub\_analyse\_MC.sh

\subsection{Step 5: Optimize cuts or train MVA}

\subsection{Step 6: Effective Areas}

To calculate effective areas, look at:

\$EVNDISPSYS/scripts/CTA/CTA.EFFAREA.sub\_analyse.sh

For the first time you have to use mscw files as input since MCpars has to be analysed once. 
If you change your cuts afterwards (but not the number of input files) you can use the faster version by using
the effective area file as input (helps a lot for protons).

% ############ Input data format ######################
\chapter{Input data format}

\section{VBF - VERITAS Bank Format}

\section{DST - data summary tree}
\label{SECTION.DST}

The DST format is a simple ROOT tree containing standard C++ variables only (no class data).

\subsection{Limitations}
\label{SUBSECTION.DST.LIMITATIONS}

The implementation requires the hardwiring of the maximum number of telescopes, channels, etc. 
These values can be found in {\texttt inc/VGlobalRunParameter}, for example:

\begin{lstlisting}
// HARDWIRED MAXIMUM NUMBER OF TELESCOPES AND CHANNELS, etc.
// maximum number of telescopes
#define VDST_MAXTELESCOPES  100
// maximum number of channels per telescopes
#define VDST_MAXCHANNELS   12000
// maximum number of summation windows
// (=maximum number of samples per FADC trace)   
#define VDST_MAXSUMWINDOW   64
// maximum number of time slices for pedestal calculation
#define VDST_PEDTIMESLICES 5000   
// maximum number of arrayreconstruction method 
#define VDST_MAXRECMETHODS  100
// maximum number of timing levels
#define VDST_MAXTIMINGLEVELS 10    
\end{lstlisting}

\noindent {\bf NOTE: } These numbers determine the memory requirements of {\it evndisp} and {\it CTA.convert\_hessio\_to\_VDST}.

\noindent {\bf NOTE: } {\it evndisp} must be compiled with the same settings as the writing program.

% ############ detector geometry ######################

\chapter{Detector Setup}


\section{Telescope types}

Different telescope types (e.g. mid-size and small-size telescopes, telescopes with different FOV, etc) are assigned a telescope type number in the code, this number is as well written to the data trees. The telescope type  contains the mirror shape (DC, Parabolic, SC), the mirror area (m$^2$), the field of view ([deg]) and the pixel size ([deg]). For VERITAS, the telescope type correspond simply to the different telescope numbers (and are therefore 0,1,2,3).

For clarification, this is the corresponding code bit from {\texttt src/CTA.convert\_hessio\_to\_VDST.cpp}:

\begin{lstlisting}
fTelescope_type  = TMath::Nint(pix_size*100.);
fTelescope_type += TMath::Nint(fFOV*10.)*100;
fTelescope_type += TMath::Nint(fMirrorArea)*100*10*100;
// all large telescopes are parabolic, all others are Davies-Cotton (hardwired)
if( fMirrorArea > fParabolic_mirrorArea )      fTelescope_type += 100000000;
// Schwarzschild-Couder: check number of mirrors
else if( fNMirrors == fSC_number_of_mirrors )  fTelescope_type += 200000000;
\end{lstlisting}

\noindent {\bf Note:} There is currently no way to determine the mirror/telescope shape (parabolic, Davies-Cotton, etc) from the hessio file. This is why the mirror area and the number of mirrors is used. 
The parabolic shape is assigned to all telescopes with a mirror area  $>$ 400 m$^2$.
Schwarzschild-Couder Design are all telescopes with 2 mirrors only.


% ############ Appendix ######################

%\begin{appendix}
 %coordinate systems
%\end{appendix}


%\bibliographystyle{plain_gm}
%\bibliographystyle{hep}
%\cleardoublepage
%\addcontentsline{toc}{chapter}{\bibname}
%\bibliography{BibAstro,BibStat,BibPhys,BibPart,BibEtc,BibKASCADE}

% #############################################


\end{document}
